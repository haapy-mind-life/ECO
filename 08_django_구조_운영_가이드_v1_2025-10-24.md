# 08. Django 구조 & 운영 가이드 (v1, 2025-10-24)

본 문서는 **FMW 사내 시스템의 Django 코드베이스**를 기준으로, 구조·설정·API·운영 절차를 **쉽고 빠르게 이해**하도록 정리한 가이드입니다.  
(대상: 초기에 20명 개발팀 → 성공 시 그룹 전체 확대)

---

## 1) 목적(Why)
- 개발자들이 **자주/편하게** 쓰는 시스템이 목표 → **사용성·안정성** 최우선
- 사내망 기준 **IP Allowlist** 중심의 단순 보안, 복잡 보안은 **확장 예정**
- NGINX가 프록시, **Django/Streamlit은 로컬 바인딩**으로 노출 축소

---

## 2) 시스템 개요(Overview)
- **Nginx**: 리버스 프록시 + IP allowlist (화이트리스트)
- **Django (DRF 포함)**: API 제공, Ops(운영) 대시보드, Admin
- **Streamlit**: 일반 사용자를 위한 UI. 데이터 매니저가 **매일 1회** Django API에서 싱크 후 로컬 캐시 사용
- **데이터 소스**: YAML 시드 + (선택) 사내 API → DB 적재

```text
[Client] ──(Allow IP)──> Nginx ──> Django(/api, /ops, /admin)
                               └─> Streamlit(/streamlit)  # 내부 로컬만 연결
```

---

## 3) 폴더 구조(핵심만)
```text
django/
 ├─ config/        # settings(dev/prod), urls, wsgi/asgi
 ├─ core/          # 도메인 모델(FeatureRecord/Taxonomy/AuditLog), 서비스, admin, 관리커맨드
 ├─ api/           # REST API (v1: 공개 CSV/JSON, dev: 동기화/요약)
 ├─ drf/           # 공용 serializer/CSV renderer/예외/페이지네이션
 ├─ ops/           # 운영자 대시보드(스태프 전용)
 ├─ templates/     # 전역 base, public 홈, admin override, ops 템플릿
 ├─ scripts/       # yaml/사내API → DB 적재, 일일 요약
 ├─ yaml/          # 시드 데이터(models, features, taxonomy, branches)
 ├─ static/, media/
 └─ requirements.txt, .env.example, manage.py
```

---

## 4) 데이터 모델 (요약)

### 4.1 `FeatureRecord`
| 필드 | 설명 |
|---|---|
| `model_name` | 단말 모델(예: S20) |
| `solution` | SoC 솔루션(예: slsi/mtk) |
| `feature_group`, `feature` | 피처 그룹/피처명 |
| `mode` | allow / block / none |
| `value` | 문자열 값 |
| `mcc`, `mnc` | 선택 차원(dim) |
| `region`, `country`, `operator`, `sp_fci` | 선택 차원(dim) |
| `sync_time` | 적재 시각 |

> **특징**: (model, solution, group, feature, dims, mode)로 **유니크 제약**.  
> dims는 **없을 수도** 있음(예: sp_fci만 존재, mcc/mnc 없음). 서비스는 존재하는 차원만 활용.

### 4.2 `TaxonomyMap`
- 별칭→정식명(canonical) 매핑. 예) `"sp white"→"SP_WHITE"`, `"Kddi"→"KDDI"`

### 4.3 `AuditLog`
- 동기화/요약 등 운영 이벤트 기록.

---

## 5) API 설계

### 5.1 공개(V1) — CSV 기본, JSON 선택
| 메소드 | 경로 | 설명 | 주요 쿼리파라미터 |
|---|---|---|---|
| GET | `/api/v1/all` | 전체 레코드 | `model_name, solution, feature_group, feature, mcc, mnc, region, country, operator, sp_fci, mode, since` |
| GET | `/api/v1/{feature_group}` | 그룹별 레코드 | 위와 동일 |

- **응답 포맷**: 기본 **CSV**(`CSVRenderer`), `?format=json` 시 JSON
- **since**: `YYYY-MM-DD`(일자 기준)

### 5.2 개발/운영(DEV)
| 메소드 | 경로 | 설명 |
|---|---|---|
| POST | `/api/dev/sync` | 스크립트 일괄 실행(백그라운드), 결과는 `AuditLog` 기록 |
| POST | `/api/dev/sync/{feature_group}` | (확장지점) 특정 그룹만 동기화 |
| GET | `/api/dev/runs/summary?days=N` | 최근 N일 `created` 카운트 추세(JSON) |

> **Note**: 정확한 **업데이트/삭제** 집계를 위해 ChangeLog/RunStat 도입 예정.

**예시**
```bash
# CSV 전체
curl -s "http://HOST/api/v1/all" > dump.csv

# JSON + 필터
curl -s "http://HOST/api/v1/Connectivity?solution=slsi&since=2025-10-01&format=json"

# 동기화 트리거
curl -X POST "http://HOST/api/dev/sync"
```

---

## 6) Ops(운영) 대시보드
- 경로: `/ops/` (스태프 전용)
- **Overview**: 오늘/어제 적재 건수, **N일 추세 라인차트**(요약 API 호출)
- **Changes**: 기간 선택 후 일간 변경 목록(현 단계는 created 기준 데모)
- **Records**: 간단 서버사이드 필터로 레코드 브라우징
- **Sync**: 버튼으로 백그라운드 동기화 실행

---

## 7) 동기화 스크립트 (scripts/)
실행 순서: `NNN_` 접두사 오름차순 → 그 외 알파벳순

| 파일 | 역할 |
|---|---|
| `010_seed_taxonomy.py` | `yaml/taxonomy.yaml` 업서트(별칭→canonical) |
| `020_parse_yaml_to_db.py` | `models.yaml × features.yaml` → `FeatureRecord` 적재 |
| `030_import_from_api.py` | (옵션) 사내 API 연동 스텁 |
| `040_compute_changes.py` | 오늘/어제 카운트 비교 요약 → `AuditLog` 기록 |
| `runner.py` | 일괄 실행, **feature_group**, **dry_run**, **ONLY/EXCLUDE** 지원 |

**관리 커맨드**
```bash
python manage.py sync_all
```

**환경변수 옵션**
```
SCRIPTS_ONLY=020_,030_
SCRIPTS_EXCLUDE=040_
FEATURE_GROUP=Connectivity
CORP_API_BASE=http://intra.api.local
CORP_API_TOKEN=secret-token
```

---

## 8) 보안/권한
- **Nginx**: IP **Allowlist**로 1차 차단 (장고/스트림릿은 내부 로컬 바인딩)
- **Django Admin**: `/admin/` (슈퍼유저, is_staff)
- **Ops**: `@staff_member_required` 적용 → 관리자 3인만 접근
- **DRF IP 제어(선택)**: `settings.DRF_IP_ALLOWLIST=['10.0.0.1', ...]` 사용 가능

---

## 9) 설정(.env) & 실행
```bash
# 로컬
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export DJANGO_SETTINGS_MODULE=config.settings.dev
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver 127.0.0.1:8000
```

**주요 키**
- `ALLOWED_HOSTS`, `CSRF_TRUSTED_ORIGINS`
- (선택) `DATABASE_URL` / 기본은 SQLite
- 운영 전환 시: `DJANGO_SETTINGS_MODULE=config.settings.prod`

---

## 10) 운영 시나리오(권장)
1. 매일 새벽 **scripts** 자동 실행(크론 or CI/CD) → DB 적재
2. Streamlit **데이터 매니저**가 1일 1회 **/api/v1**/`/api/dev`에서 스냅샷 수집
3. 운영자는 **/ops/**에서 KPI/변경/레코드 확인, 필요 시 **수동 동기화** 실행
4. 이슈 발생 시 **AuditLog**/서버 로그 확인 → 재실행/롤백

---

## 11) 확장 로드맵
- ChangeLog/RunStat 모델로 **C/U/D** 정확 집계 및 타임라인 제공
- `/api/dev/sync/{feature_group}` 실제 그룹별 파이프라인 분리
- OpenAPI 스키마 정리, Admin 내보내기/Import 강화, CSV 스트리밍

---

## 12) 빠른 점검 체크리스트
- [ ] `/api/v1/all` CSV 정상 다운로드
- [ ] `/api/dev/runs/summary?days=14` JSON 정상
- [ ] `/ops/` 대시보드 표시 & 스태프 권한 확인
- [ ] `python manage.py sync_all` 정상 동작
- [ ] Nginx IP Allowlist 적용 및 Django/Streamlit 내부 바인딩

---

### 부록) 용어(간단)
- **feature_group/feature**: 기능 그룹/개별 기능
- **dims**: 선택적 차원(MCC/MNC/REGION/COUNTRY/OPERATOR/SP_FCI)
- **canonicalize**: 별칭을 정식명으로 통일 (`TaxonomyMap`)

