좋아요, 선생님.
**완전 처음부터 다시**, “생각 과정 = 단계 나눔” 방식으로 정리하면서
**1단계: 아웃룩에서 메일 가져오기 + 원본 데이터 디버깅 출력** 까지만 깔끔하게 만들어요.
(Ollama 요약은 이게 잘 돌아가는 걸 확인한 다음 2단계에서 붙이면 됩니다.)

---

## 0. 이번 목표 정리

이번 단계에서 우리가 만들 건 딱 하나입니다:

> ✅ **Outlook 2016에서 최근 N시간 메일을 읽어서**
>
> * 가져온 메일 개수 출력
> * 각 메일의 `받은 시간`, `보낸 사람`, `제목`, `본문 앞부분`을 **그대로 출력**하는 디버그용 스크립트

위 스크립트가 잘 동작하면:

* Outlook COM 연결 정상 ✅
* Restrict 필터(시간 조건) 정상 ✅
* Body/Subject 등 한글도 잘 가져오는지 확인 ✅

그 다음에 그 위에 **Ollama 요약 코드**를 얹으면 됩니다.

---

## 1. 프로젝트 폴더 & 가상환경 준비 (D 드라이브 기준)

### 1-1. 프로젝트 폴더

이미 계획하신 대로:

```text
D:\workspace\mail_summary_ollama
```

를 사용합니다.

### 1-2. 명령 프롬프트에서 폴더 이동

```cmd
cd /d D:\workspace\mail_summary_ollama
```

### 1-3. 가상환경 생성

```cmd
python -m venv venv
```

생성 후 구조:

```text
D:\workspace\mail_summary_ollama
 ├─ venv\
 └─ (나중에) debug_outlook_mails.py, requirements.txt ...
```

### 1-4. 가상환경 활성화

```cmd
D:\workspace\mail_summary_ollama\venv\Scripts\activate
```

프롬프트 앞에 `(venv)` 붙으면 OK.

---

## 2. requirements.txt 생성 & 설치

### 2-1. `requirements.txt` 파일 내용

`D:\workspace\mail_summary_ollama\requirements.txt` 에 아래 내용 저장:

```text
pywin32==306
requests==2.31.0
```

(지금 디버그 스크립트는 `requests` 안 써도 되지만,
어차피 나중에 Ollama 쓸 거라 같이 넣어둡니다.)

### 2-2. 설치

```cmd
pip install -r requirements.txt
```

---

## 3. 디버그용 파이썬 파일 생성

이제 **순수 Outlook 디버깅용 코드**를 하나 만듭니다.

파일 이름:
`D:\workspace\mail_summary_ollama\debug_outlook_mails.py`

내용 전체는 아래처럼 넣어주세요.

---

### 📄 `debug_outlook_mails.py` 전체 코드

```python
import win32com.client
from datetime import datetime, timedelta


# =========================
# 설정 영역
# =========================

# 최근 몇 시간 메일을 볼지 (디버그용)
LOOKBACK_HOURS = 3

# 본문을 최대 몇 글자까지 출력할지 (너무 길면 잘라냄)
BODY_PREVIEW_CHARS = 500


# =========================
# Outlook에서 메일 가져오기
# =========================

def fetch_mails_since(since):
    """
    since 이후에 받은편지함 메일을 가져와서 리스트로 반환.
    각 요소는 raw Outlook 아이템(메일) 객체 그대로 둡니다.
    (디버깅용: 나중에 dict 변환도 가능)
    """
    # Outlook 2016 COM 객체 생성
    outlook = win32com.client.Dispatch("Outlook.Application")
    namespace = outlook.GetNamespace("MAPI")

    # 6 = olFolderInbox (기본 받은편지함)
    inbox = namespace.GetDefaultFolder(6)
    items = inbox.Items

    # 최신 메일부터 정렬
    items.Sort("[ReceivedTime]", True)

    # Outlook Restrict 필터용 시간 포맷 (MM/DD/YYYY HH:MM AM/PM)
    filter_time = since.strftime("%m/%d/%Y %I:%M %p")
    restriction = f"[ReceivedTime] >= '{filter_time}'"

    print(f"[DEBUG] Restrict 필터 조건: {restriction}")

    restricted_items = items.Restrict(restriction)

    mails = []

    for item in restricted_items:
        # item이 메일이 아닐 수도 있어서, 예외 처리 + 타입 체크
        try:
            # 43 = olMailItem (메일 아이템)
            if getattr(item, "Class", None) != 43:
                # 회의 요청/보고서 등 메일이 아닌 경우 스킵
                continue

            mails.append(item)
        except Exception as e:
            print("[WARN] 아이템 처리 중 오류 (무시):", e)
            continue

    return mails


# =========================
# 디버그 출력 함수
# =========================

def print_mail_debug_info(mails):
    """
    가져온 메일들의 개수, 제목, 받은 시간, 보낸 사람, 본문 앞부분 출력.
    """
    count = len(mails)
    print("=" * 80)
    print(f"[INFO] 가져온 메일 개수: {count}")
    print("=" * 80)

    for idx, mail in enumerate(mails, start=1):
        try:
            subject = str(getattr(mail, "Subject", "") or "")
            sender = str(getattr(mail, "SenderName", "") or "")
            to = str(getattr(mail, "To", "") or "")
            received_time = getattr(mail, "ReceivedTime", None)
            body = str(getattr(mail, "Body", "") or "")

            if isinstance(received_time, datetime):
                received_str = received_time.strftime("%Y-%m-%d %H:%M:%S")
            else:
                received_str = str(received_time)

            # 본문 미리보기 자르기
            body_preview = body.strip().replace("\r\n", "\n").replace("\r", "\n")
            if len(body_preview) > BODY_PREVIEW_CHARS:
                body_preview = body_preview[:BODY_PREVIEW_CHARS] + "\n...(이하 생략)..."

            print(f"\n----- 메일 {idx} -----")
            print(f"[받은 시간] {received_str}")
            print(f"[보낸 사람] {sender}")
            print(f"[받는 사람] {to}")
            print(f"[제목] {subject}")
            print("- 본문 미리보기 -")
            print(body_preview)
            print("-" * 40)

        except Exception as e:
            print(f"[WARN] 메일 {idx} 출력 중 오류 (무시):", e)
            continue


# =========================
# 메인 실행
# =========================

def main():
    now = datetime.now()
    since = now - timedelta(hours=LOOKBACK_HOURS)

    print(f"[INFO] 현재 시각: {now.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"[INFO] 최근 {LOOKBACK_HOURS}시간 기준: {since.strftime('%Y-%m-%d %H:%M:%S')} 이후 메일 조회")

    mails = fetch_mails_since(since)

    print_mail_debug_info(mails)


if __name__ == "__main__":
    main()
```

---

## 4. 실행 방법 & 기대 출력

### 4-1. 실행

가상환경이 활성화된 상태에서:

```cmd
(venv) D:\workspace\mail_summary_ollama> python debug_outlook_mails.py
```

> ⚠️ **Outlook 2016은 실행된 상태**여야 합니다.
> (계정 로그인된 상태, 메일 정상 수신 중)

### 4-2. 정상일 때 콘솔 예시

예상되는 화면 예시 (형식만):

```text
[INFO] 현재 시각: 2025-11-25 12:03:10
[INFO] 최근 3시간 기준: 2025-11-25 09:03:10 이후 메일 조회
[DEBUG] Restrict 필터 조건: [ReceivedTime] >= '11/25/2025 09:03 AM'
================================================================================
[INFO] 가져온 메일 개수: 4
================================================================================

----- 메일 1 -----
[받은 시간] 2025-11-25 11:58:32
[보낸 사람] 홍길동
[받는 사람] 선생님 <...@company.com>
[제목] [FMW] 회귀 테스트 범위 논의
- 본문 미리보기 -
안녕하세요.
오늘 오후 회귀 테스트 범위 관련해서 정리드리려고 합니다...
...(이하 생략)...
----------------------------------------

----- 메일 2 -----
...
```

여기서 확인할 것:

1. `[DEBUG] Restrict 필터 조건`이 **오늘 날짜 + 시간**으로 잘 나오는지
2. `[INFO] 가져온 메일 개수`가 Outlook 받은편지함과 감각적으로 맞는지
3. 한글 제목/본문이 깨지지 않고 잘 보이는지
4. 본문이 너무 길지 않고 잘 잘려 있는지

---

## 5. 이 디버그 스크립트가 중요한 이유

1. **Outlook COM 연결 문제**를 먼저 잡을 수 있음

   * Outlook이 안 켜져 있거나, 프로필 문제, 권한 문제 등
2. **시간 필터(Restrict) 조건이 제대로 걸리는지** 확인

   * 시간대/포맷 이슈가 있을 수 있어서 `[DEBUG]` 출력이 필요
3. **메일 원본 데이터(Subject/Body)가 실제로 어떻게 들어오는지** 파악

   * 회의 요청/시스템 메일 등은 `Class != 43`라서 스킵되는 것도 확인

이게 OK면, 다음 단계에서:

* `fetch_mails_since` → `dict` 리스트로 바꾸기
* 그걸 `Ollama`에 던지는 요약 스크립트 (`mail_summary_ollama.py`)로 확장

을 하면 됩니다.

---

## 6. 다음 단계 예고 (지금 당장은 안 해도 됨)

이 디버그 코드가 잘 돌아간다는 전제 하에:

1. `fetch_mails_since()`를

   * raw Outlook item 대신
   * `{"subject": ..., "body": ..., "received_time": ...}` 딕셔너리 리스트로 변환하는 버전 추가
2. 그 리스트를

   * 텍스트로 쭉 이어서(`build_thread_text`)
   * `call_ollama()`로 gpt-oss:20b에 보내기
3. Markdown으로 저장하는

   * `save_summary_markdown()` 함수 추가

→ 이게 이전에 만든 `mail_summary_ollama.py`의 구조입니다.
이번엔 **그 전에 디버깅을 충분히 하고 들어가는** 버전이라고 이해하시면 돼요.

---

선생님,
1️⃣ 위 디버그 스크립트 한 번 돌려보시고,
2️⃣ 콘솔에 찍힌 로그/에러 메세지/메일 예시 몇 개를 알려주시면

그 결과를 가지고
→ “시간 필터·한글 깨짐·메일 개수·본문 길이”를 함께 점검하고
→ 그다음에 **요약 + 자동화 단계**로 넘어가면 딱 좋겠습니다.
