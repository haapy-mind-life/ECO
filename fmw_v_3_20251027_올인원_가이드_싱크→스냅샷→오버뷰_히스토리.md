# FMW v3_20251027 — 올인원 가이드 (싱크→스냅샷→오버뷰/히스토리)

> **목표:** 이해 쉽고, 바꾸기 쉽고, 오래 가는 구조. v3 기준 유지 + UX/운영만 가볍게 개선.

---

## 1) 한 장 요약 (개념)
- **features**: “지금 상태표(스냅샷)” — 현재 최종 값
- **changes**: “변경 일지(히스토리)” — 스냅샷 간 차이(C/U/D)
- **runs**: “수집 실행 기록” — 배치/작업 메모(언제/상태)
- **daily_counts**: “오버뷰 요약” — 1/7/14/30일 CRUD 합계
- **name_map**: “이름 사전” — 별칭→표준명 정규화용

> 홈(오버뷰) = **daily_counts**  |  히스토리화면 = **changes**  |  전체 현황/다운로드 = **features**

---

## 2) 동작 흐름 (싱크→스냅샷→요약)
1. 외부 전체 싱크 수집 → (옵션) `staging_features` 적재
2. `name_map`으로 표준화 + `identity_hash` 계산
3. 기존 `features`와 비교(diff) → `changes`(created/updated/deleted) 생성
4. **features upsert** (신규/변경 반영) + 삭제 반영
5. `daily_counts`(1/7/14/30) 갱신
6. `runs`에 작업 결과 기록

---

## 3) 테이블 요약 (스키마 핵심)
### features (스냅샷)
- 핵심: `model_name, solution, feature_group, feature, mode, value`
- 차원: `mcc, mnc, region, country, operator, sp_fci`
- 키: `identity_hash`(UNIQUE), `sync_time`

### changes (히스토리)
- `changed_at`, `action`(created/updated/deleted), `run_id`
- before/after: `mode_before/after`, `value_before/after`
- 자유차원: `dims_json`(새 차원 추가 시 DDL 없이 흡수)
- 멱등/중복방지: `(run_id, identity_hash, action, ...)` 유니크

### runs (작업 기록)
- `run_id`(PK), `status`, `finished_at`, `note`

### daily_counts (오버뷰)
- `date`, `window`(1/7/14/30), `created/updated/deleted/errors`
- 유니크: `(date, window)`

### name_map (표준화 사전)
- `kind`(예: operator, feature 등), `alias`, `canonical`

---

## 4) ERD
- 시각 파일: **[erd_fmw_v3_20251027.svg](sandbox:/mnt/data/erd_fmw_v3_20251027.svg)**

---

## 5) API (OpenAPI 3.1)
- 스키마 파일: **[openapi_v3_20251027.yaml](sandbox:/mnt/data/openapi_v3_20251027.yaml)**

### 5.1 스냅샷 조회 (CSV 기본)
```
GET /api/v1/all
Accept: text/csv   # 권장 (대량 다운로드)
# 또는 Accept: application/json
```
예)
```
/api/v1/all?feature_group=IMS&country=KR
```

### 5.2 히스토리 조회
```
GET /api/v1/history
Accept: text/csv | application/json
```
예) VoLTE 업데이트만, 기간 필터
```
/api/v1/history?action=updated&feature_group=IMS&feature=VoLTE&date_from=2025-10-01&date_to=2025-10-27
```
예) 자유검색(dims_json 포함)
```
/api/v1/history?q=mcc:450
```

### 5.3 오버뷰(홈) 요약
```
GET /api/dev/runs/summary?days=1|7|14|30
GET /api/dev/runs/summary?days=1&yesterday=true
```
- 응답: 날짜별 `{created, updated, deleted, errors}`

---

## 6) DRF에서 “전체 스냅샷 파일” 받기 (CSV/JSON)
- CSV(권장)
```
GET /api/v1/all
Accept: text/csv
```
- JSON
```
GET /api/v1/all
Accept: application/json
```
- 구현 포인트: **StreamingHttpResponse + iterator()** (대용량 안전), **.only(...)**로 필요한 칼럼만 SELECT, 적절한 인덱스

---

## 7) 운영 팩(SQL) — 싱크 파이프라인 핵심
- SQL Pack: **[db_sync_pack_v3_20251027.sql](sandbox:/mnt/data/db_sync_pack_v3_20251027.sql)**
- 포함: created/updated/deleted diff 생성→`changes` 적재, `features` upsert/삭제 반영, `daily_counts` 갱신(1일 예시)

---

## 8) 유지보수/확장 원칙
- **단순**: 이름 직관적(`features`, `changes`, `runs`)
- **확장**: 새 차원은 `dims_json`에 넣고 `q=키:값`으로 검색
- **안정**: `identity_hash`로 동일 항목 식별, 중복 방지
- **시간대**: 저장 UTC, 화면 표기는 KST(Asia/Seoul)

---

## 9) 보관 정책(권장)
- `daily_counts`: 90일 보관
- `changes`: 180일 보관 (업무 기준에 맞게 조정)

---

## 10) Streamlit 연결 팁
- **홈(오버뷰)**: 프리셋(오늘/어제/7/14/30) → `/api/dev/runs/summary` 바인딩
- **히스토리**: CRUD/기간/q 검색 → `/api/v1/history` 표 + CSV 다운로드 버튼
- **전체 현황**: 필터 폼 → `/api/v1/all`(CSV) 바로 저장
- 주의: 일자별 합계에 `updated/deleted`가 0인 날도 **0 컬럼**을 반드시 채워서 그리기(누락 시 에러 방지)

---

## 11) 바로 쓰는 cURL
```bash
# 7일 오버뷰
curl -s "https://api.example.com/api/dev/runs/summary?days=7" -H "Accept: application/json"

# 히스토리: VoLTE 업데이트, 10/01~10/27
curl -s "https://api.example.com/api/v1/history?action=updated&feature_group=IMS&feature=VoLTE&date_from=2025-10-01&date_to=2025-10-27" \
  -H "Accept: text/csv" -o history_volte.csv

# 현재 스냅샷: 한국 IMS만 CSV
curl -s "https://api.example.com/api/v1/all?feature_group=IMS&country=KR" \
  -H "Accept: text/csv" -o features_ims_kr.csv
```

---

## 12) 버전/호환성
- 문서 버전: **v3_20251027**
- v3 계약 유지(엔드포인트/이름) + UX/운영 개선만 반영
- v4로 확장 시에도 본 구조는 그대로 사용 가능(차원 추가는 `dims_json`)

