# ğŸ—„ï¸ FMW DB Overview Â· Schema Â· DRF/API (2025â€‘11â€‘03)

**ê¸°ì¤€ ë¬¸ì„œ:** ìµœì‹  _FMW Project/Architecture Overview_ ë°˜ì˜  
**Phaseâ€‘1:** SQLite(Windows) â†’ **Phaseâ€‘2:** PostgreSQL  
**ë³´ì•ˆ:** NGINX **IP Allowlist**(1ì°¨) + DRF **ê¶Œí•œ/Throttle**(2ì°¨), **ReqLog** ì „ë©´ ê°ì‚¬

> ë³¸ ë¬¸ì„œëŠ” **DB ëª¨ë¸/ìŠ¤í‚¤ë§ˆ/DRF/API**ë¥¼ í•œ ë²ˆì— ìµœì‹ í™”í•©ë‹ˆë‹¤. ì•„ë˜ **v1 ë¦¬ì†ŒìŠ¤**ëŠ” Cohortë„ ì ‘ê·¼, **dev ë¦¬ì†ŒìŠ¤**ëŠ” ìš´ì˜ 3ì¸(IP+`Xâ€‘APIâ€‘Key`) ì „ìš©ì…ë‹ˆë‹¤.

---

## 0) ëª¨ë¸ ì¹´íƒˆë¡œê·¸ (ìš”êµ¬ ë°˜ì˜)

### v1 (Readâ€‘Only)

- **Features** â€” ì •ì±…/í”¼ì²˜ ìŠ¤ëƒ…ìƒ·(SSOT)
- **AllowList** â€” í—ˆìš© ê·œì¹™ ë·°(Featuresì—ì„œ `mode='allow'` íŒŒìƒ)
- **BlockList** â€” ì°¨ë‹¨ ê·œì¹™ ë·°(Featuresì—ì„œ `mode='block'` íŒŒìƒ)
- **RelFeatures** â€” í”¼ì²˜ ê°„ ê´€ê³„(ì˜ì¡´/ì¶©ëŒ/ìƒí˜¸ë°°íƒ€ ë“±)
- **AsRel** â€” ë„ë©”ì¸ ê°„ ì—°ê´€ ê·œì¹™(ëª¨ë¸â†”ì‚¬ì—…ì ë“± ì‚¬ìƒ ê·œì¹™)
- **UeCapa** â€” ë‹¨ë§(UE) ê¸°ëŠ¥/ê·œê²© ìŠ¤ëƒ…ìƒ·

### dev (Ops ì „ìš©)

- **SlsiAllowList / MtkAllowList** â€” ë²¤ë” ì†ŒìŠ¤ í—ˆìš© ë¦¬ìŠ¤íŠ¸(ìŠ¤í…Œì´ì§•)
- **SlsiBlockList / MtkBlockList** â€” ë²¤ë” ì†ŒìŠ¤ ì°¨ë‹¨ ë¦¬ìŠ¤íŠ¸(ìŠ¤í…Œì´ì§•)
- **UeCapaRecord** â€” UE Capability ì›ì²œ ë ˆì½”ë“œ(ì •ê·œí™” ì „)
- **NameMap** â€” ë³„ì¹­â†’í‘œì¤€ ë§¤í•‘ í…Œì´ë¸”
- **MccMncMap** â€” MCC/MNCâ†’ì§€ì—­/êµ­ê°€/ì‚¬ì—…ì ë³´ê°•
- **AccessLog** â€” ì ‘ê·¼ ê°ì‚¬(`req_log`)
- **SyncHistory** â€” ë™ê¸°í™” ì‹¤í–‰ ì´ë ¥(`runs`)
- **Changes** â€” C/U/D ë³€ê²½ íˆìŠ¤í† ë¦¬

---

## 1) ë…¼ë¦¬ ERD (Mermaid)

```mermaid
erDiagram
  FEATURES ||--o{ CHANGES : "by identity"
  RUNS ||--o{ CHANGES : "run_id"
  MCC_MNC_MAP }o--|| FEATURES : "(mcc,mnc) -> meta"
  NAME_MAP }o..|| FEATURES : "normalize"
  FEATURES ||..|{ DAILY_COUNTS : "aggregated"
  REQ_LOG ||..|| FEATURES : "access trend (derived)"
  REL_FEATURES }o--|| FEATURES : "parent_feature -> features(identity_hash)"
  REL_FEATURES }o--|| FEATURES : "child_feature  -> features(identity_hash)"
  AS_REL }o..|| NAME_MAP : "uses canonical dims"
  UE_CAPA ||..|| NAME_MAP : "uses canonical dims"

  FEATURES {bigint id PK text model_name text solution text feature_group text feature text mode text value text mcc text mnc char2 region char2 country text operator text sp_fci text identity_hash UK timestamptz sync_time}
  REL_FEATURES {bigint id PK text parent_feature_hash text child_feature_hash text relation text scope jsonb dims_json}
  AS_REL {bigint id PK text a_dim text a_value text b_dim text b_value text rel_type numeric weight timestamptz updated_at}
  UE_CAPA {bigint id PK text model_name text category text item text capa_value text source timestamptz reported_at}
  CHANGES {bigint id PK text action jsonb dims_json text mode_before text mode_after text value_before text value_after text run_id timestamptz changed_at}
  RUNS {bigint id PK text run_id UK timestamptz started_at timestamptz finished_at text status int created int updated int deleted text notes}
  NAME_MAP {bigint id PK text kind text alias text canonical timestamptz updated_at}
  MCC_MNC_MAP {bigint id PK varchar3 mcc varchar3 mnc char2 region char2 country text operator}
  REQ_LOG {bigint id PK timestamptz ts text remote_ip text ns text method text path int status int duration_ms text api_key_hash text user_agent int allowed}
```

> **AllowList/BlockList**ëŠ” ë¬¼ë¦¬ í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ **DB View**(ë˜ëŠ” DRF í•„í„°)ë¡œ ë…¸ì¶œ ê¶Œì¥.

---

## 2) ë¬¼ë¦¬ ìŠ¤í‚¤ë§ˆ (Phaseâ€‘1/2 ê³µí†µ ì§€ì¹¨)

- **í‚¤/ë©±ë“±**: `identity_hash = sha256(normalized_keyset)`(ëª¨ë¸/ì†”ë£¨ì…˜/ê·¸ë£¹/í”¼ì²˜/ëª¨ë“œ/ê°’/ì§€ì—­/êµ­ê°€/ì‚¬ì—…ì ë“±)
- **ì‹œê°„ëŒ€**: ì €ì¥ UTC(Phaseâ€‘2 `timestamptz`), í‘œì‹œ KST
- **ê²€ì¦**: `solution âˆˆ {slsi, mtk}`, `mode âˆˆ {allow, block, none}`, `mcc=3ìë¦¬`, `mnc=2~3ìë¦¬`, `country=ISOâ€‘alpha2`
- **ì„±ëŠ¥**: ìµœê·¼ 90ì¼ partial index, `lower(model_name)` expr index, JSONB GIN(`dims_json`)@PG

### 2.1 í•µì‹¬ í…Œì´ë¸” (PG DDL ì˜ˆì‹œ)

```sql
CREATE TABLE features (
  id BIGSERIAL PRIMARY KEY,
  model_name TEXT NOT NULL,
  solution TEXT NOT NULL CHECK (solution IN ('slsi','mtk')),
  feature_group TEXT NOT NULL,
  feature TEXT NOT NULL,
  mode TEXT NOT NULL CHECK (mode IN ('allow','block','none')),
  value TEXT,
  mcc TEXT, mnc TEXT, region CHAR(2), country CHAR(2), operator TEXT, sp_fci TEXT,
  identity_hash TEXT UNIQUE NOT NULL,
  sync_time TIMESTAMPTZ NOT NULL
);
CREATE INDEX idx_features_sync_recent ON features(sync_time DESC)
  WHERE sync_time >= now() - interval '90 days';
CREATE INDEX idx_features_model_lower ON features(lower(model_name));

CREATE TABLE rel_features (
  id BIGSERIAL PRIMARY KEY,
  parent_feature_hash TEXT NOT NULL,
  child_feature_hash  TEXT NOT NULL,
  relation TEXT NOT NULL CHECK (relation IN ('depends_on','conflicts_with','implies')),
  scope TEXT,
  dims_json JSONB
);
CREATE INDEX idx_rel_parent ON rel_features(parent_feature_hash);
CREATE INDEX idx_rel_child  ON rel_features(child_feature_hash);

CREATE TABLE as_rel (
  id BIGSERIAL PRIMARY KEY,
  a_dim TEXT NOT NULL, a_value TEXT NOT NULL,
  b_dim TEXT NOT NULL, b_value TEXT NOT NULL,
  rel_type TEXT NOT NULL CHECK (rel_type IN ('maps_to','excludes','aliases')),
  weight NUMERIC,
  updated_at TIMESTAMPTZ DEFAULT now()
);
CREATE UNIQUE INDEX ux_as_rel ON as_rel(a_dim,a_value,b_dim,b_value,rel_type);

CREATE TABLE ue_capa (
  id BIGSERIAL PRIMARY KEY,
  model_name TEXT NOT NULL,
  category TEXT NOT NULL,  -- e.g., 'IMS','RAT','Band'
  item TEXT NOT NULL,      -- e.g., 'VoLTE','NR','n78'
  capa_value TEXT,
  source TEXT,
  reported_at TIMESTAMPTZ
);

CREATE TABLE changes (
  id BIGSERIAL PRIMARY KEY,
  action TEXT NOT NULL CHECK (action IN ('created','updated','deleted')),
  dims_json JSONB,
  mode_before TEXT, mode_after TEXT,
  value_before TEXT, value_after TEXT,
  run_id TEXT,
  changed_at TIMESTAMPTZ NOT NULL
);
CREATE INDEX idx_changes_changed_at ON changes (changed_at DESC);

CREATE TABLE runs (
  id BIGSERIAL PRIMARY KEY,
  run_id TEXT UNIQUE NOT NULL,
  started_at TIMESTAMPTZ, finished_at TIMESTAMPTZ, status TEXT,
  created INT, updated INT, deleted INT, notes TEXT
);

CREATE TABLE name_map (
  id BIGSERIAL PRIMARY KEY,
  kind TEXT NOT NULL,
  alias TEXT NOT NULL,
  canonical TEXT NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(kind, alias)
);

CREATE TABLE mcc_mnc_map (
  id BIGSERIAL PRIMARY KEY,
  mcc VARCHAR(3) NOT NULL,
  mnc VARCHAR(3) NOT NULL,
  region CHAR(2), country CHAR(2), operator TEXT,
  UNIQUE(mcc, mnc)
);

CREATE TABLE req_log (
  id BIGSERIAL PRIMARY KEY,
  ts TIMESTAMPTZ NOT NULL,
  remote_ip TEXT NOT NULL,
  ns TEXT NOT NULL,         -- v1/dev/ops/admin/streamlit
  method TEXT NOT NULL,
  path TEXT NOT NULL,
  status INT NOT NULL,
  duration_ms INT NOT NULL,
  api_key_hash TEXT,
  user_agent TEXT,
  allowed INT DEFAULT 1
);
CREATE INDEX idx_reqlog_ts ON req_log (ts DESC);
CREATE INDEX idx_reqlog_ns_ts ON req_log (ns, ts DESC);
CREATE INDEX idx_reqlog_ip_ts ON req_log (remote_ip, ts DESC);
```

### 2.2 íŒŒìƒ ë·° (ê¶Œì¥)

```sql
CREATE VIEW v1_allow_list AS
  SELECT * FROM features WHERE mode='allow';
CREATE VIEW v1_block_list AS
  SELECT * FROM features WHERE mode='block';
```

### 2.3 ìŠ¤í…Œì´ì§•(ë²¤ë”/ì›ì²œ)

```sql
CREATE TABLE slsi_allow_list   (like features including all);
CREATE TABLE slsi_block_list   (like features including all);
CREATE TABLE mtk_allow_list    (like features including all);
CREATE TABLE mtk_block_list    (like features including all);
CREATE TABLE ue_capa_record (
  id BIGSERIAL PRIMARY KEY,
  model_name TEXT, raw_payload JSONB, source TEXT, received_at TIMESTAMPTZ DEFAULT now()
);
```

---

## 3) DRF / API ì„¤ê³„ (ìµœì‹ )

### 3.1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ & ê¶Œí•œ

- **v1**: Cohort í¬í•¨, **IP Allowlist**(Nginx) + `IsIPAllowedV1`
- **dev**: ìš´ì˜ 3ì¸ ì „ìš©, **IP Allowlist** + `IsIPAllowedDevWithKey`(**IP + `Xâ€‘APIâ€‘Key`**)
- (ê¶Œì¥) Throttle: v1=`100/min`, dev=`20/min`

### 3.2 v1 ì—”ë“œí¬ì¸íŠ¸

- `GET /api/v1/features` â€” í•„í„°: `model_name, solution, feature_group, feature, mode, value, mcc, mnc, region, country, operator, sp_fci`
- `GET /api/v1/allow-list` â€” (= `v1_allow_list` ë·° ë˜ëŠ” `mode=allow`)
- `GET /api/v1/block-list` â€” (= `v1_block_list` ë·° ë˜ëŠ” `mode=block`)
- `GET /api/v1/rel-features` â€” í•„í„°: `parent_feature_hash, child_feature_hash, relation`
- `GET /api/v1/as-rel` â€” í•„í„°: `a_dim,a_value,b_dim,b_value,rel_type`
- `GET /api/v1/ue-capa` â€” í•„í„°: `model_name, category, item`
- `GET /api/v1/features/download` â€” CSV ë‚´ë³´ë‚´ê¸°

### 3.3 dev ì—”ë“œí¬ì¸íŠ¸ (Ops)

- `GET /api/dev/slsi/allow-list` Â· `GET /api/dev/mtk/allow-list`
- `GET /api/dev/slsi/block-list` Â· `GET /api/dev/mtk/block-list`
- `GET /api/dev/ue-capa-record`
- `GET /api/dev/name-map` Â· `POST /api/dev/name-map`(ì˜µì…˜: ê´€ë¦¬)
- `GET /api/dev/mcc-mnc-map`
- `GET /api/dev/access-log` â€” (= `req_log`) í•„í„°: `from,to,ns,ip,path,status`
- `GET /api/dev/sync-history` â€” (= `runs`)
- `GET /api/dev/changes` â€” í•„í„°: `run_id, action, from, to`
- (ì˜µì…˜) `POST /api/dev/sync/run` â€” ìˆ˜ë™ ë™ê¸°í™” íŠ¸ë¦¬ê±°

> dev ì“°ê¸°(POST)ëŠ” ë‚´ë¶€ ìŠ¹ì¸ ì‹œì—ë§Œ í™œì„±í™”.

### 3.4 ì§ë ¬í™”(ë°œì·Œ)

```python
class FeatureSerializer(ModelSerializer):
    class Meta: model=Feature; fields='__all__'
class RelFeatureSerializer(ModelSerializer):
    class Meta: model=RelFeature; fields='__all__'
class AsRelSerializer(ModelSerializer):
    class Meta: model=AsRel; fields='__all__'
class UeCapaSerializer(ModelSerializer):
    class Meta: model=UeCapa; fields='__all__'

class NameMapSerializer(ModelSerializer):
    class Meta: model=NameMap; fields='__all__'
class MccMncMapSerializer(ModelSerializer):
    class Meta: model=MccMncMap; fields='__all__'
class AccessLogSerializer(ModelSerializer):
    class Meta: model=ReqLog; fields=['ts','remote_ip','ns','method','path','status','duration_ms']
class RunSerializer(ModelSerializer):
    class Meta: model=Run; fields='__all__'
class ChangeSerializer(ModelSerializer):
    class Meta: model=Change; fields='__all__'
```

### 3.5 ë¼ìš°íŒ…(ë°œì·Œ)

```python
# v1
router.register(r'v1/features', FeatureViewSet)
router.register(r'v1/allow-list', AllowListViewSet)
router.register(r'v1/block-list', BlockListViewSet)
router.register(r'v1/rel-features', RelFeatureViewSet)
router.register(r'v1/as-rel', AsRelViewSet)
router.register(r'v1/ue-capa', UeCapaViewSet)
# dev
router.register(r'dev/slsi/allow-list', SlsiAllowListViewSet)
router.register(r'dev/mtk/allow-list',  MtkAllowListViewSet)
router.register(r'dev/slsi/block-list', SlsiBlockListViewSet)
router.register(r'dev/mtk/block-list',  MtkBlockListViewSet)
router.register(r'dev/ue-capa-record',  UeCapaRecordViewSet)
router.register(r'dev/name-map',        NameMapViewSet)
router.register(r'dev/mcc-mnc-map',     MccMncMapViewSet)
router.register(r'dev/access-log',      AccessLogViewSet)
router.register(r'dev/sync-history',    RunViewSet, basename='runs')
router.register(r'dev/changes',         ChangeViewSet)
```

### 3.6 ì‘ë‹µ ì˜ˆì‹œ

```json
GET /api/v1/allow-list?model_name=A50&feature=VoLTE
[
  {
    "model_name":"A50","solution":"slsi","feature_group":"IMS","feature":"VoLTE",
    "mode":"allow","value":"on","mcc":"450","mnc":"05","country":"KR",
    "operator":"SKT","identity_hash":"...","sync_time":"2025-11-03T00:00:00Z"
  }
]
```

---

## 4) ë§ˆì´ê·¸ë ˆì´ì…˜/ì „í™˜

- Phaseâ€‘1 ìµœì†Œ FK â†’ Phaseâ€‘2ì— `changes.run_idâ†’runs`, `features(mcc,mnc)â†’mcc_mnc_map` ì„ íƒ FK ë„ì…
- ì‚¬ì „ ì ì¬(READâ€‘ONLY ê²€ì¦) â†’ ì¦ë¶„ ì´ê´€ â†’ ì»¤ë„¥ì…˜ ìŠ¤ìœ„ì¹˜ â†’ ì¹´ìš´íŠ¸Â·í•´ì‹œÂ·KPI ëŒ€ì¡° â†’ ë¡¤ë°± ìŠ¤ëƒ…ìƒ·

---

## 5) ê²€ì¦/ìš´ì˜ DoD

- [ ] v1 ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ **P95<5s**, CSV Export ì •í•©
- [ ] dev ì—”ë“œí¬ì¸íŠ¸ **IP+Key**Â·Throttle í†µê³¼ìë§Œ ì ‘ê·¼
- [ ] `req_log` ëˆ„ë½ ì—†ìŒ(ê¸°ê°„/NS/IP/Status í•„í„°)
- [ ] DB ì œì•½/ì¸ë±ìŠ¤ ì‹¤í–‰ ê³„íš ì ê²€(ìµœê·¼ 90ì¼ partial/expr/GIN/BRIN)

---

## ë¶€ë¡ A) í’ˆì§ˆ SQL (PG)

```sql
-- ë„ë©”ì¸ ê²€ì¦
SELECT COUNT(*) FROM features WHERE solution NOT IN ('slsi','mtk');
SELECT COUNT(*) FROM features WHERE mode NOT IN ('allow','block','none');
SELECT COUNT(*) FROM features WHERE mcc IS NOT NULL AND mcc !~ '^\d{3}$';
SELECT COUNT(*) FROM features WHERE country IS NOT NULL AND country !~ '^[A-Z]{2}$';
-- í•´ì‹œ ìœ ì¼ì„±
SELECT identity_hash, COUNT(*) FROM features GROUP BY 1 HAVING COUNT(*)>1;
```

## ë¶€ë¡ B) ë·° êµ¬í˜„ ëŒ€ì•ˆ

- ì„±ëŠ¥ì´ ì¶©ë¶„í•˜ë©´ **ë·° ì—†ì´ DRF í•„í„°**ë§Œìœ¼ë¡œ `allow-list/block-list` ì œê³µ ê°€ëŠ¥
- ë¹ˆë²ˆíˆ ì‚¬ìš©ë˜ëŠ” ê²½ìš° DB View ë˜ëŠ” **ë¬¼ë¦¬í™”(Materialized View)** + ë°°ì¹˜ ë¦¬í”„ë ˆì‹œ ê¶Œì¥

ì™„ë£Œ! **â€œFMW_DB_Overview_Schema_DRF_API_20251103.mdâ€** ë¬¸ì„œë¥¼ ìº”ë²„ìŠ¤ì— ìƒˆë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.  
ìš”ì²­í•˜ì‹  **v1/ dev ëª¨ë¸ êµ¬ì„±(Features, Allow/Block, RelFeatures, AsRel, UeCapaâ€¦ ë“±)**ì„ ë°˜ì˜í–ˆê³ , ERDÂ·PG DDLÂ·íŒŒìƒë·°Â·DRF ì—”ë“œí¬ì¸íŠ¸Â·ì‹œë¦¬ì–¼ë¼ì´ì €Â·ë¼ìš°íŒ…Â·ê²€ì¦ SQLÂ·DoDê¹Œì§€ í•œ ë²ˆì— ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

í•„ìš”í•˜ì‹œë©´:

- ì´ ë¬¸ì„œë¥¼ **PDF/ZIP**ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°,
- **OpenAPI YAML** ì „ì²´ë³¸ ìƒì„±,
- **ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸**(SQLiteâ†’PostgreSQL) ìë™ ìƒì„±

ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.